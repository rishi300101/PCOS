<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCOS Risk Assessment System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .content {
            padding: 40px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 600;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group input {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input::placeholder {
            color: #999;
        }

        .help-text {
            font-size: 0.85em;
            color: #777;
            margin-top: 5px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            display: block;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .reset-btn {
            background: #6c757d;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            display: block;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
        }

        .reset-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.5);
        }

        .reset-btn:active {
            transform: translateY(0);
        }

        .button-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .result-section {
            margin-top: 40px;
            padding: 30px;
            border-radius: 15px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-section.low-risk {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #155724;
        }

        .result-section.medium-risk {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            color: #856404;
        }

        .result-section.high-risk {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #721c24;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .result-icon {
            font-size: 2.5em;
        }

        .result-title {
            font-size: 1.8em;
            font-weight: 600;
        }

        .probability-box {
            background: rgba(255, 255, 255, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .probability-value {
            font-size: 3em;
            font-weight: 700;
            margin: 10px 0;
        }

        .probability-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .message-box {
            background: rgba(255, 255, 255, 0.4);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1.1em;
            line-height: 1.6;
            font-weight: 500;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-top: 30px;
            font-size: 0.9em;
            color: #555;
        }

        .info-box strong {
            color: #667eea;
        }

        .flow-section {
            margin-top: 35px;
            padding: 25px 20px;
            background: #fdfdff;
            border-radius: 12px;
            border: 1px solid #e0e3ff;
        }

        .flow-section h2 {
            font-size: 1.4em;
            color: #4b5bdc;
            margin-bottom: 15px;
        }

        .flow-subtitle {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 20px;
        }

        .flow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .flow-card {
            background: white;
            border-radius: 10px;
            border: 1px solid #e1e4ff;
            padding: 15px 18px;
        }

        .flow-card.low h3 {
            color: #1b7f4a;
        }

        .flow-card.medium h3 {
            color: #856404;
        }

        .flow-card.high h3 {
            color: #b21f2d;
        }

        .flow-card h3 {
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .flow-card ul {
            margin-left: 18px;
            margin-top: 5px;
            font-size: 0.95em;
            color: #555;
        }

        .flow-footer {
            margin-top: 10px;
            font-size: 0.95em;
            color: #444;
        }

        .flow-footer span {
            font-weight: 600;
            color: #4b5bdc;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .content {
                padding: 25px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .result-title {
                font-size: 1.4em;
            }

            .probability-value {
                font-size: 2.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ PCOS Risk Assessment</h1>
            <p>Comprehensive Polycystic Ovary Syndrome Risk Evaluation System</p>
        </div>

        <div class="content">
            <!-- Risk prediction toggle -->
            <button type="button" class="submit-btn" id="toggle-prediction" style="max-width: 220px; margin-bottom: 10px;">
                üßÆ Risk Prediction
            </button>

            <div id="prediction-section" style="{% if result %}display:block;{% else %}display:none;{% endif %};">
                <div class="form-section">
                    <h2>Patient Information</h2>
                    <form method="POST">
                        <div class="form-grid">
                        <div class="form-group">
                            <label for="age">Age (years) *</label>
                            <input type="number" id="age" name="age" required min="1" max="100" placeholder="Enter your age" value="{{ form_values.get('age', '') }}">
                        </div>

                        <div class="form-group">
                            <label for="height">Height (cm) *</label>
                            <input type="number" id="height" name="height" required min="100" max="250" step="0.1" placeholder="e.g., 165" value="{{ form_values.get('height', '') }}">
                            <span class="help-text">Enter height in centimeters</span>
                        </div>

                        <div class="form-group">
                            <label for="weight">Weight (kg) *</label>
                            <input type="number" id="weight" name="weight" required min="30" max="300" step="0.1" placeholder="e.g., 65" value="{{ form_values.get('weight', '') }}">
                            <span class="help-text">Enter weight in kilograms</span>
                        </div>

                        <div class="form-group">
                            <label for="amh">AMH (ng/mL)</label>
                            <input type="number" id="amh" name="amh" step="0.1" min="0" placeholder="Anti-M√ºllerian Hormone" value="{{ form_values.get('amh', '') }}">
                            <span class="help-text">Normal range: 1.0-4.0 ng/mL</span>
                        </div>

                        <div class="form-group">
                            <label for="tsh">TSH (mIU/L)</label>
                            <input type="number" id="tsh" name="tsh" step="0.1" min="0" placeholder="Thyroid Stimulating Hormone" value="{{ form_values.get('tsh', '') }}">
                            <span class="help-text">Normal range: 0.4-4.0 mIU/L</span>
                        </div>

                        <div class="form-group">
                            <label for="fsh">FSH (mIU/mL)</label>
                            <input type="number" id="fsh" name="fsh" step="0.1" min="0" placeholder="Follicle Stimulating Hormone" value="{{ form_values.get('fsh', '') }}">
                            <span class="help-text">Normal range: 3.0-10.0 mIU/mL</span>
                        </div>

                        <div class="form-group">
                            <label for="lh">LH (mIU/mL)</label>
                            <input type="number" id="lh" name="lh" step="0.1" min="0" placeholder="Luteinizing Hormone" value="{{ form_values.get('lh', '') }}">
                            <span class="help-text">Normal range: 1.0-12.0 mIU/mL</span>
                        </div>

                            <div class="form-group">
                                <label for="cycle">Cycle Regularity *</label>
                                <input type="number" id="cycle" name="cycle" required min="0" max="2" placeholder="0, 1, or 2" value="{{ form_values.get('cycle', '') }}">
                                <span class="help-text">0=Irregular, 1=Regular, 2=Other</span>
                            </div>
                        </div>

                        <div class="button-group">
                            <button type="submit" class="submit-btn">üîç Assess PCOS Risk</button>
                            <button type="reset" class="reset-btn">üîÑ Reset Form</button>
                        </div>
                    </form>
                </div>
            </div>

            {% if result and message and risk %}
            <div class="result-section {% if risk == 'LOW' %}low-risk{% elif risk == 'MEDIUM' %}medium-risk{% else %}high-risk{% endif %}">
                <div class="result-header">
                    <div class="result-icon">
                        {% if risk == 'LOW' %}‚úÖ{% elif risk == 'MEDIUM' %}‚ö†Ô∏è{% else %}üö®{% endif %}
                    </div>
                    <div class="result-title">
                        {% if risk == 'LOW' %}Low Risk Assessment
                        {% elif risk == 'MEDIUM' %}Medium Risk Assessment
                        {% else %}High Risk Assessment{% endif %}
                    </div>
                </div>

                <div class="probability-box">
                    <div class="probability-label">PCOS Probability</div>
                    <div class="probability-value">{{ (result * 100)|round(1) }}%</div>
                </div>

                <div class="message-box">
                    <strong>{{ message }}</strong>
                </div>

                <div class="button-group" style="max-width: 260px; margin-top: 10px;">
                    <button type="button" class="submit-btn" id="lifestyle-btn" data-risk="{{ risk }}" style="max-width: 220px;">
                        üåø Recommend lifestyle
                    </button>
                </div>
            </div>
            {% endif %}

            <div class="info-box">
                <strong>‚ÑπÔ∏è Important Note:</strong> This assessment tool is for informational purposes only and should not replace professional medical advice. Please consult with a healthcare provider for proper diagnosis and treatment recommendations.
            </div>

            <div class="flow-section">
                <h2>How your results are used</h2>
                <p class="flow-subtitle">
                    Only carefully validated records are used later for improving the PCOS prediction model. The flow below summarizes what happens after each risk category.
                </p>

                <div class="flow-grid">
                    <div class="flow-card low">
                        <h3>Low Risk</h3>
                        <ul>
                            <li>Immediate feedback is shown to the user</li>
                            <li>Basic lifestyle guidance is provided</li>
                            <li>Data is stored as candidate record</li>
                            <li>Used later for retraining (offline)</li>
                        </ul>
                    </div>

                    <div class="flow-card medium">
                        <h3>Moderate Risk</h3>
                        <ul>
                            <li>Lifestyle intervention is recommended</li>
                            <li>Follow-up suggested in 3‚Äì4 months</li>
                            <li>Outcome is validated first</li>
                            <li>Then used for model retraining</li>
                        </ul>
                    </div>

                    <div class="flow-card high">
                        <h3>High Risk</h3>
                        <ul>
                            <li>Doctor consultation is strongly suggested</li>
                            <li>Result should be confirmed clinically</li>
                            <li>Only verified records are used later</li>
                            <li>Helps safely improve future predictions</li>
                        </ul>
                    </div>
                </div>

                <p class="flow-footer">
                    <span>Validated records only</span> ‚ü∂ Offline batch retraining ‚ü∂ Updated PCOS risk prediction model.
                </p>
            </div>

            <div class="flow-section">
                <h2>Risk trends over time</h2>
                <p class="flow-subtitle">Your PCOS risk probabilities over time (month-wise view).</p>
                <canvas id="riskChart" height="120"></canvas>
            </div>

        </div>
    </div>

    <!-- Floating AI assistant widget -->
    <div id="chat-widget" style="position: fixed; bottom: 90px; right: 20px; width: 320px; max-height: 420px; background: #ffffff; border-radius: 12px; border: 1px solid #e1e4ff; box-shadow: 0 10px 30px rgba(0,0,0,0.25); display: none; z-index: 1000; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; padding:10px 14px; display:flex; align-items:center; justify-content:space-between;">
            <span style="font-weight:600;">AI Lifestyle Assistant</span>
            <button type="button" id="chat-close" style="background:transparent;border:none;color:#fff;font-size:1.1em;cursor:pointer;">√ó</button>
        </div>
        <div id="chat-box" style="background:#ffffff;padding:10px 12px;max-height:260px;overflow-y:auto;font-size:0.9em;">
            <div style="margin-bottom:8px;"><strong>Assistant:</strong> I'm here to help with lifestyle guidance related to PCOS. What would you like to know?</div>
        </div>
        <form id="chat-form" style="padding:8px 10px 4px 10px;">
            <input type="text" id="chat-input" placeholder="Type your question..." style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #d0d4ff;box-sizing:border-box;margin-bottom:6px;font-size:0.9em;">
            <button type="submit" class="submit-btn" style="max-width:140px;margin:0 auto 4px auto;padding:8px 16px;font-size:0.9em;">Send</button>
        </form>
        <p style="padding:0 12px 8px 12px;font-size:0.8em;color:#666;">
            Lifestyle guidance only. Not a substitute for professional medical consultation.
        </p>
    </div>
    <button id="chat-toggle" style="position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; box-shadow: 0 8px 24px rgba(0,0,0,0.35); cursor:pointer; font-size:0.8em; font-weight:600; z-index:1000;">
        Chat
    </button>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function() {
            const labels = {{ trend_labels|default("[]")|safe }};
            const values = {{ trend_values|default("[]")|safe }};
            if (labels.length && values.length) {
                const ctx = document.getElementById('riskChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'PCOS Risk Probability',
                            data: values.map(v => Math.round(v * 1000) / 10),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.15)',
                            tension: 0.25,
                            fill: true,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'Risk Probability (%)' },
                                min: 0,
                                max: 100
                            }
                        }
                    }
                });
            }
        })();

        (function() {
            const form = document.getElementById('chat-form');
            const input = document.getElementById('chat-input');
            const box = document.getElementById('chat-box');
            const widget = document.getElementById('chat-widget');
            const toggleBtn = document.getElementById('chat-toggle');
            const closeBtn = document.getElementById('chat-close');
            const lifestyleBtn = document.getElementById('lifestyle-btn');

            if (toggleBtn && widget) {
                toggleBtn.addEventListener('click', function() {
                    widget.style.display = widget.style.display === 'block' ? 'none' : 'block';
                });
            }

            if (closeBtn && widget) {
                closeBtn.addEventListener('click', function() {
                    widget.style.display = 'none';
                });
            }

            if (lifestyleBtn && widget && input) {
                lifestyleBtn.addEventListener('click', function() {
                    widget.style.display = 'block';
                    const riskLevel = lifestyleBtn.getAttribute('data-risk') || 'your current';
                    input.value = 'Recommend lifestyle changes for ' + riskLevel + ' PCOS risk.';
                    input.focus();
                });
            }

            if (!form) return;

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const text = (input.value || '').trim();
                if (!text) return;

                const userHtml = document.createElement('div');
                userHtml.style.marginBottom = '8px';
                userHtml.innerHTML = '<strong>You:</strong> ' + text;
                box.appendChild(userHtml);
                box.scrollTop = box.scrollHeight;

                input.value = '';

                try {
                    const res = await fetch("{{ url_for('chat') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text })
                    });
                    const data = await res.json();
                    const reply = data.reply || data.error || 'Sorry, something went wrong.';
                    const botHtml = document.createElement('div');
                    botHtml.style.marginBottom = '8px';
                    botHtml.innerHTML = '<strong>Assistant:</strong> ' + reply;
                    box.appendChild(botHtml);
                    box.scrollTop = box.scrollHeight;
                } catch (err) {
                    const botHtml = document.createElement('div');
                    botHtml.style.marginBottom = '8px';
                    botHtml.innerHTML = '<strong>Assistant:</strong> There was a problem sending your message. Please try again.';
                    box.appendChild(botHtml);
                    box.scrollTop = box.scrollHeight;
                }
            });
        })();
    </script>
</body>
</html>
